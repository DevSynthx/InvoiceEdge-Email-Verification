<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvoiceEdge Email Verification</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            text-align: center;
            padding: 2rem;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin: 1rem;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 2.5rem;
        }

        p {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .button {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }

        .button:hover {
            background-color: #3182ce;
        }

        .warning {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .success {
            color: #38a169;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .debug {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Welcome to InvoiceEdge!</h1>
        <p>You're being redirected to complete your email verification. Please ensure you're on your mobile device for
            seamless redirection to the app.</p>

        <div id="debug-info" class="debug"></div>

        <button class="button" onclick="redirectToApp()">Redirect to App</button>

        <div id="status-message"></div>

        <p class="warning">Note: If you're viewing this on a desktop computer, please open this link on your mobile
            device where InvoiceEdge is installed.</p>
    </div>

    <script>
        let verificationData = null;

        function extractParameters() {
            let userId = null;
            let secret = null;

            // Method 1: Regular query parameters
            const urlParams = new URLSearchParams(window.location.search);
            userId = urlParams.get('userId');
            secret = urlParams.get('secret');

            // Method 2: Hash fragment as query params
            if ((!userId || !secret) && window.location.hash) {
                const hash = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hash);
                userId = userId || hashParams.get('userId');
                secret = secret || hashParams.get('secret');
            }

            // Method 3: Parse hash as complete URL
            if ((!userId || !secret) && window.location.hash) {
                try {
                    const hashContent = window.location.hash.substring(1);
                    if (hashContent.startsWith('http')) {
                        const hashUrl = new URL(hashContent);
                        userId = userId || hashUrl.searchParams.get('userId');
                        secret = secret || hashUrl.searchParams.get('secret');
                    }
                } catch (e) {
                    console.log('Method 3 failed:', e);
                }
            }

            // Method 4: Manual parsing of hash content
            if ((!userId || !secret) && window.location.hash) {
                const hashContent = window.location.hash.substring(1);
                const userIdMatch = hashContent.match(/userId=([^&]+)/);
                const secretMatch = hashContent.match(/secret=([^&]+)/);

                if (userIdMatch) userId = decodeURIComponent(userIdMatch[1]);
                if (secretMatch) secret = decodeURIComponent(secretMatch[1]);
            }

            return { userId, secret };
        }

        function updateDebugInfo(data) {
            const debugDiv = document.getElementById('debug-info');
            if (debugDiv) {
                debugDiv.innerHTML = `
                    <strong>Debug Info:</strong><br>
                    UserId: ${data.userId || 'Not found'}<br>
                    Secret: ${data.secret ? 'Found (' + data.secret.length + ' chars)' : 'Not found'}<br>
                    Full URL: ${window.location.href}<br>
                    Search: ${window.location.search || 'None'}<br>
                    Hash: ${window.location.hash || 'None'}<br>
                    Status: ${data.userId && data.secret ? '✅ Ready' : '❌ Missing parameters'}
                `;
            }
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<p class="${isError ? 'warning' : 'success'}">${message}</p>`;
        }

        function redirectToApp() {
            if (!verificationData || !verificationData.userId || !verificationData.secret) {
                showStatus("Verification information is missing. Please check your verification link.", true);
                return;
            }

            const deepLink = `invoiceedge://verify?userId=${encodeURIComponent(verificationData.userId)}&secret=${encodeURIComponent(verificationData.secret)}`;
            console.log('Attempting redirect to:', deepLink);

            showStatus("Redirecting to app...");

            // Create a temporary link and click it
            const link = document.createElement('a');
            link.href = deepLink;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show fallback message after a delay
            setTimeout(() => {
                showStatus("If the app didn't open, please make sure InvoiceEdge is installed on your device.", true);
            }, 3000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            verificationData = extractParameters();
            updateDebugInfo(verificationData);

            console.log('Extracted verification data:', verificationData);

            // Auto redirect after a short delay if we have the required data
            if (verificationData.userId && verificationData.secret) {
                showStatus("Verification data found. Redirecting automatically in 3 seconds...");
                setTimeout(() => {
                    redirectToApp();
                }, 3000);
            } else {
                showStatus("Could not find verification parameters in the URL.", true);
            }

            // Clean up URL
            if (window.history && window.history.replaceState) {
                const cleanUrl = window.location.protocol + "//" +
                    window.location.host + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        });
    </script>
</body>

</html>